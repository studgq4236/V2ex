{% extends 'base.html' %}

{% block left_main %}
<div class="card">
    <div class="node_header card-body">
        <div class="row" id="node-info">
            <div class="node_avatar col-1">
                <img src="{{ url_for('static',filename='img/node') }}/{{ node.avatar }}" width="72" height="72" />
            </div>
            <div class="node_info row col-11">
                <div class="col-5" style="font-size: 14px;">
                    <p><a href="/" style="color: #03c8ff !important;">V2EX</a> › {{ node.name }}</p>
                </div>
                <div class="col-4">
                    <button type="button" class="btn btn-link btn-sm" data-toggle="modal" data-target="#edit-node">编辑</button>
                </div>
                <div class="col-3">
                    <p>主题总数 <strong>{{ node.posts.count() }}</strong>  •
                        {% if current_user.is_authenticated %}
                        <a href="#" style="color: #03c8ff !important;" id="collect" data-catid="{{ node.id }}">{% if node.collection(current_user) %}取消收藏{% else %}加入收藏{% endif %}</a>
                        {% else %}
                        <a href="{{ url_for('main.collect_node') }}" style="color: #03c8ff !important;">加入收藏</a>
                        {% endif %}
                    </p>
                </div>
                <div class="col-10">
                    <p>{{ node.header }}</p>
                </div>
                <div class="col-2">
                    <button style="border-radius: 2px;">创建新主题</button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <nav aria-label="Page navigation example">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if not pageination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for(endpoint,name=node.name, page=pageination.page -1) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                {% for p in pageination.iter_pages() %}
                    {% if p %}
                        {% if p == pageination.page %}
                            <li class="page-item active">
                                <span class="page-link">
                                {{ p }}
                                <span class="sr-only">(current)</span>
                                </span>
                            </li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="{{ url_for(endpoint,name=node.name, page=p) }}">{{ p }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#">&hellip;</a></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not pageination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for(endpoint,name=node.name, page=pageination.page +1) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
                </li>
            </ul>
        </nav>
    </div>
    <ul class="list-group list-group-flush">
        {% for p in posts %}
        <li class="list-group-item">
            <div class="row">
                <div class="col-md-1"><a href="{{ url_for('main.user',username=p.author.username) }}"> <img src="{{ p.author.gravatar() }}" height="48px" width="48px" class="rounded"></a> </div>
                <div class="col-md-10">
                    <span class="post-title"><a href="{{ url_for('main.post',id=p.id) }}" id="post-title">{{ p.title }}</a></span><br />
                    <span class="post-info">
                        <strong style="color:#4d5256;"><a href="{{ url_for('main.user',username=p.author.username) }}"> {{ p.author.username }}</a> </strong>
                        &nbsp • &nbsp<script>document.write(moment("{{ p.publish_time }}").fromNow());</script>
                        {% if p.comments.count() > 0 %}
                        &nbsp • &nbsp最后回复来自 <a href="{{ url_for('main.user',username=p.comments.all()[-1].author.username) }}"> {{ p.comments.all()[-1].author.username }}</a>
                        {% endif %}
                    </span>
                </div>
                <div class="col-md-1"><span class="badge badge-pill badge-info">{{ p.comments.count() }}</span></div>
            </div>
        </li>
        {% endfor %}
        <li class="list-group-item" style="padding-left: 10px">
            <nav aria-label="Page navigation example">
                <ul class="pagination pagination-sm">
                    <li class="page-item {% if not pageination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(endpoint,name=node.name, page=pageination.page -1) }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>
                    {% for p in pageination.iter_pages() %}
                        {% if p %}
                            {% if p == pageination.page %}
                                <li class="page-item active">
                                    <span class="page-link">
                                    {{ p }}
                                    <span class="sr-only">(current)</span>
                                    </span>
                                </li>
                            {% else %}
                                <li class="page-item"><a class="page-link" href="{{ url_for(endpoint,name=node.name, page=p) }}">{{ p }}</a></li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled"><a class="page-link" href="#">&hellip;</a></li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {% if not pageination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for(endpoint,name=node.name, page=pageination.page +1) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                    </li>
                </ul>
            </nav>
        </li>
        <li class="list-group-item" style="padding-left: 10px;">
            <p style="font-size: 14px;margin-bottom: 0px;">第 {{ (pageination.page-1)*2+1 }}到 {{ pageination.page*2 }} / 共 {{ node.posts.count() }} 个主题</p>
        </li>
    </ul>
</div>

<div class="modal fade" id="edit-node">
    <div class="modal-dialog">
        <div class="modal-content">

          <!-- 模态框头部 -->
            <div class="modal-header">
            <h4 class="modal-title">编辑节点信息</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <form id="edit-node" method="post" enctype="multipart/form-data" action="{{ url_for('main.node',name=node.name) }}">
                    <div class="form-group">
                        <lable for="avatar">图片</lable>
                        <input type="file" class="form-control-file" id="avatar" name="avatar" />
                    </div>
                    <div class="form-group">
                        <label for="header">描述</label>
                        <input type="text" class="form-control" id="header" name="header" />
                    </div>
                    <button type="submit" class="btn-primary">提交</button>
                </form>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>

        </div>
    </div>
</div>
    <script>
    $('#collect').click(function () {
        var node_id = $(this).attr("data-catid");
        $.get('{{ url_for('main.collect_node') }}',{node_id:node_id}, function (data) {
            $('#collect').html(data);
        });
        
    });
    </script>
{% endblock %}

{% block right_main %}
{% include 'right_user_card.html' %}
{% endblock %}